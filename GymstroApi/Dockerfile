FROM node:12.13.0-alpine

WORKDIR /home/node/app

ARG KEYCLOAK_REALM_NAME
ENV KEYCLOAK_REALM_NAME="${KEYCLOAK_REALM_NAME}"

ARG HASURA_GRAPHQL_ENGINE_URL
ENV HASURA_GRAPHQL_ENGINE_URL="${HASURA_GRAPHQL_ENGINE_URL}"

ARG KEYCLOAK_ADMIN_CLI_USERNAME
ENV KEYCLOAK_ADMIN_CLI_USERNAME="${KEYCLOAK_ADMIN_CLI_USERNAME}"

ARG KEYCLOAK_ADMIN_CLI_PASSWORD
ENV KEYCLOAK_ADMIN_CLI_PASSWORD="${KEYCLOAK_ADMIN_CLI_PASSWORD}"

ARG KEYCLOAK_URL
ENV KEYCLOAK_URL="${KEYCLOAK_URL}"

ARG S3_BUCKET
ENV S3_BUCKET=$S3_BUCKET

ARG AWS_ACCESS_KEY_ID
ENV AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID

ARG AWS_SECRET_ACCESS_KEY
ENV AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

ARG AWS_DEFAULT_REGION
ENV AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION

COPY package.json .
RUN npm install

COPY . .

# ENV NODE_ENV=production
ENV NODE_ENV=development

ENV PORT=8001

RUN npm run build

# RUN npm ci
# RUN npm run build

USER node

EXPOSE 8001

CMD [ "node", "dist/index.js" ]